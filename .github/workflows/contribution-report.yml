name: GitHub Contributions Report

on:
  schedule:
    - cron: "0 19 * * 5"  # Runs every Friday at 3 PM EST (7 PM UTC)
  workflow_dispatch:  # Allows manual triggering

jobs:
  generate-report:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set Up Environment
        run: |
          echo "Setting up environment..."
          sudo apt-get update
          sudo apt-get install -y jq

      - name: Set Variables
        run: |
          echo "Setting up variables..."
          USERNAME="ashleyhenry15"
          ORGS=("rstudio" "posit-dev")
          TOKEN="${{ secrets.WEEKLYCLASSIC }}"
          DATE=$(TZ="America/New_York" date +"%Y-%m-%d")
          REPORT_DIR="reports"
          REPORT_FILE="$REPORT_DIR/contributions-$DATE.md"
          
          mkdir -p "$REPORT_DIR"
          
          echo "USERNAME=$USERNAME" >> $GITHUB_ENV
          echo "DATE=$DATE" >> $GITHUB_ENV
          echo "REPORT_FILE=$REPORT_FILE" >> $GITHUB_ENV
          echo "REPORT_DIR=$REPORT_DIR" >> $GITHUB_ENV

      - name: Debug - Check Date and Report Path
        run: |
          echo "Expected report filename: $REPORT_FILE"
          ls -l "$REPORT_DIR"

      - name: Fetch Contributions and Generate Report
        run: |
          echo "# GitHub Contributions Report - $DATE" > "$REPORT_FILE"
          echo "" >> "$REPORT_FILE"

          for ORG in "${ORGS[@]}"; do
            echo "Fetching data for organization: $ORG"

            # Fetch GitHub events
            EVENTS=$(curl -s -H "Authorization: token $TOKEN" "https://api.github.com/users/$USERNAME/events?per_page=100")
            
            # Debugging: Show fetched events
            echo "Raw GitHub events:"
            echo "$EVENTS" | jq '.[].type' || echo "No events found."

            # Extract repository names where contributions occurred
            ACTIVE_REPOS=$(echo "$EVENTS" | jq -r '.[].repo.name' | sort | uniq)

            if [[ -z "$ACTIVE_REPOS" ]]; then
              echo "No active repositories found for $ORG in the past 7 days." | tee -a "$REPORT_FILE"
              continue
            fi

            echo "## Organization: $ORG" >> "$REPORT_FILE"
            echo "" >> "$REPORT_FILE"

            for REPO in $ACTIVE_REPOS; do
              echo "### Repository: $REPO" >> "$REPORT_FILE"
              
              PRs=$(echo "$EVENTS" | jq --arg REPO "$REPO" '[.[] | select(.repo.name==$REPO and .type=="PullRequestEvent")] | length')
              Issues=$(echo "$EVENTS" | jq --arg REPO "$REPO" '[.[] | select(.repo.name==$REPO and .type=="IssuesEvent")] | length')
              Reviews=$(echo "$EVENTS" | jq --arg REPO "$REPO" '[.[] | select(.repo.name==$REPO and .type=="PullRequestReviewEvent")] | length')

              echo "- **Pull Requests Opened**: $PRs" >> "$REPORT_FILE"
              echo "- **Issues Opened**: $Issues" >> "$REPORT_FILE"
              echo "- **Reviews Given**: $Reviews" >> "$REPORT_FILE"
              echo "" >> "$REPORT_FILE"
            done
          done

          echo "Report content:"
          cat "$REPORT_FILE"

      - name: Debug - Check If File Is Created
        run: |
          echo "Checking if report file exists..."
          ls -l "$REPORT_DIR"
          cat "$REPORT_FILE"

      - name: Commit and Push Report
        run: |
          git config --global user.name "github-actions"
          git config --global user.email "github-actions@github.com"

          git add "$REPORT_DIR"
          git status

          if git diff --cached --quiet; then
            echo "No changes to commit."
            exit 0
          fi

          git commit -m "Updated GitHub contributions report for $DATE"
          git push
