name: Generate GitHub Contribution Report

on:
  schedule:
    - cron: "0 15 * * 5"  # Every Friday at 3pm EST (8pm UTC)
  workflow_dispatch:

jobs:
  generate:
    runs-on: ubuntu-latest
    steps:
      - name: â¬‡ï¸ Checkout repo
        uses: actions/checkout@v4

      - name: ğŸ Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: 3.11

      - name: ğŸ“¦ Install dependencies
        run: pip install PyGithub pytz

      - name: ğŸ“ Generate contribution report
        env:
          GITHUB_TOKEN: ${{ secrets.WEEKLY_TOKEN }}
          REPOS: ${{ secrets.REPO_LIST }}
        run: |
          python <<EOF
          import os
          from datetime import datetime, timedelta
          from github import Github
          import pytz

          token = os.environ["GITHUB_TOKEN"]
          repos_raw = os.environ["REPOS"].strip().splitlines()
          g = Github(token)

          # Parse repo|product_name format
          repo_map = {}
          for line in repos_raw:
              if "|" in line:
                  repo_name, product_name = line.split("|", 1)
                  repo_map[repo_name.strip()] = product_name.strip()
              else:
                  repo_map[line.strip()] = line.strip()

          repos = list(repo_map.keys())

          user = "AshleyHenry15"
          utc = pytz.UTC
          since = datetime.utcnow().replace(tzinfo=utc) - timedelta(days=7)
          until = datetime.utcnow().replace(tzinfo=utc)
          timestamp = datetime.utcnow().strftime('%Y-%m-%d')
          output_path = f"reports/report-{timestamp}.md"

          summary = []  # List of dicts for the summary table

          os.makedirs("reports", exist_ok=True)
          with open(output_path, "w", encoding="utf-8") as f:
              f.write(f"# ğŸ“Š GitHub Contribution Report ({timestamp})\\n\\n")

              # Placeholder for summary, we'll come back and insert this
              summary_start = f.tell()
              f.write("_Generating summary..._\n\n")

              for repo_name in repos:
                  repo = g.get_repo(repo_name)
                  product_name = repo_map[repo_name]
                  print(f"ğŸ” Checking {product_name}...")

                  pr_count = 0
                  issue_count = 0
                  closed_issue_count = 0
                  review_count = 0

                  # Collect PRs
                  pr_list = []
                  for pr in repo.get_pulls(state="all", sort="created", direction="desc"):
                      if pr.created_at < since:
                          break
                      if pr.user.login == user:
                          pr_list.append((pr.number, pr.title))
                          pr_count += 1

                  # Collect Issues
                  issue_list = []
                  for issue in repo.get_issues(state="all", since=since):
                      if issue.pull_request is None and issue.user.login == user:
                          issue_list.append((issue.number, issue.title))
                          issue_count += 1

                  # Collect Closed Issues
                  closed_issue_list = []
                  for issue in repo.get_issues(state="closed", since=since):
                      if issue.pull_request is None and issue.user.login == user:
                          closed_issue_list.append((issue.number, issue.title))
                          closed_issue_count += 1

                  # Collect Reviews
                  review_list = []
                  for pr in repo.get_pulls(state="all", sort="created", direction="desc"):
                      if pr.created_at < since:
                          break
                      try:
                          for review in pr.get_reviews():
                              if review.user.login == user and since <= review.submitted_at.replace(tzinfo=utc) <= until:
                                  review_list.append((pr.number, pr.title))
                                  review_count += 1
                                  break  # One review per PR
                      except Exception as e:
                          print(f"âš ï¸ Failed to fetch reviews for PR #{pr.number} in {product_name}: {e}")

                  # Only write section if there's any activity
                  has_activity = pr_count > 0 or issue_count > 0 or closed_issue_count > 0 or review_count > 0
                  if has_activity:
                      f.write(f"## ğŸ“˜ {product_name}\\n")

                      # Pull Requests
                      f.write("### ğŸ”§ Pull Requests\\n")
                      if pr_list:
                          for pr_num, pr_title in pr_list:
                              f.write(f"- [#{pr_num}] {pr_title}\\n")
                      else:
                          f.write("_No PRs created in this repo._\\n")

                      # Issues
                      f.write("\\n### ğŸ› Issues\\n")
                      if issue_list:
                          for issue_num, issue_title in issue_list:
                              f.write(f"- [#{issue_num}] {issue_title}\\n")
                      else:
                          f.write("_No issues created in this repo._\\n")

                      # Closed Issues
                      f.write("\\n### âœ… Closed Issues\\n")
                      if closed_issue_list:
                          for issue_num, issue_title in closed_issue_list:
                              f.write(f"- [#{issue_num}] {issue_title} (closed)\\n")
                      else:
                          f.write("_No issues closed in this repo._\\n")

                      # Reviews
                      f.write("\\n### ğŸ‘€ PR Reviews\\n")
                      if review_list:
                          for pr_num, pr_title in review_list:
                              f.write(f"- [#{pr_num}] {pr_title} (reviewed)\\n")
                      else:
                          f.write("_No reviews in this repo._\\n")

                      summary.append({
                          "repo": product_name,
                          "prs": pr_count,
                          "issues": issue_count,
                          "closed_issues": closed_issue_count,
                          "reviews": review_count,
                      })

                      f.write("\\n---\\n\\n")

              # Calculate totals
              total_prs = sum(entry['prs'] for entry in summary)
              total_issues = sum(entry['issues'] for entry in summary)
              total_closed_issues = sum(entry['closed_issues'] for entry in summary)
              total_reviews = sum(entry['reviews'] for entry in summary)

              # Write summary table
              f.seek(summary_start)
              f.write("| Repository | PRs | Issues | Closed Issues | Reviews |\\n")
              f.write("|------------|-----|--------|---------------|---------|\\n")
              for entry in summary:
                  f.write(f"| {entry['repo']} | {entry['prs']} | {entry['issues']} | {entry['closed_issues']} | {entry['reviews']} |\\n")
              # Add totals row
              f.write(f"| **Total** | **{total_prs}** | **{total_issues}** | **{total_closed_issues}** | **{total_reviews}** |\\n")
              f.write("\\n")
          EOF

      - name: ğŸ“¤ Commit and push report
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git add reports/
          git commit -m "ğŸ—“ï¸ Weekly contribution report"
          git push
