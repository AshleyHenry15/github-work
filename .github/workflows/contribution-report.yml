name: Contribution Report

on:
  schedule:
    - cron: '0 15 * * 5'  # Every Friday at 3:00 PM EST
  workflow_dispatch:  # Manual trigger

jobs:
  generate-report:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout the repository
        uses: actions/checkout@v2

      - name: Set up Python environment
        uses: actions/setup-python@v2
        with:
          python-version: '3.9'

      - name: Install required Python packages
        run: |
          python -m pip install --upgrade pip
          pip install requests jq
      - name: Fetch repositories from multiple organizations
        id: fetch_repos
        run: |
          # List of organizations
          orgs=("rstudio" "posit-dev")  # Updated with your organizations
          token="${{ secrets.WEEKLY }}"  # Using your new token
          repos=""
          # Loop through each organization and fetch repositories
          for org in "${orgs[@]}"; do
            echo "Fetching repositories for organization: $org"
            response=$(curl -H "Authorization: token $token" \
                             "https://api.github.com/orgs/$org/repos?per_page=100")
            
            # Debugging: Print raw response
            echo "Response from GitHub API:"
            echo "$response"
            # Check if response is an array and contain 'full_name'
            # If the response is not an array, we should inspect and adjust accordingly
            org_repos=$(echo "$response" | jq -r 'if type == "array" then .[] | .full_name else "No valid repos" end')
            # Append repos to the list
            repos+="$org_repos\n"
          done
          echo "Repositories: $repos"
          echo "::set-output name=repos::$repos"
      - name: Fetch contributions from all repositories
        id: fetch_contributions
        run: |
          repos="${{ steps.fetch_repos.outputs.repos }}"
          token="${{ secrets.WEEKLY }}"  # Using your new token
          # Placeholder for the report
          report="## Weekly Contribution Report\n\n"
          # Loop through each repo to gather contributions
          for repo in $repos; do
            report+="### Repository: $repo\n\n"
            # Fetch issues, PRs, commits, reviews using GitHub API
            issues=$(curl -H "Authorization: token $token" "https://api.github.com/repos/$repo/issues?state=all")
            prs=$(curl -H "Authorization: token $token" "https://api.github.com/repos/$repo/pulls?state=all")
            commits=$(curl -H "Authorization: token $token" "https://api.github.com/repos/$repo/commits?since=2025-03-01T00:00:00Z")
            reviews=$(curl -H "Authorization: token $token" "https://api.github.com/repos/$repo/pulls/comments")
            # Append contributions to the report
            report+="**Issues:**\n$issues\n\n"
            report+="**Pull Requests:**\n$prs\n\n"
            report+="**Commits:**\n$commits\n\n"
            report+="**Reviews:**\n$reviews\n\n"
          done
          echo "$report" > report.md
      - name: Commit and push the report to GitHub
        run: |
          git config --global user.name 'GitHub Action'
          git config --global user.email 'action@github.com'
          git remote set-url origin https://x-access-token:${{ secrets.WEEKLY }}@github.com/AshleyHenry15/github-work.git
          git add report.md
          git commit -m "Update contribution report"
          git push