name: Generate GitHub Contribution Report

on:
  schedule:
    - cron: "0 15 * * 5"  # Every Friday at 3pm EST (8pm UTC)
  workflow_dispatch:

jobs:
  generate:
    runs-on: ubuntu-latest
    steps:
      - name: â¬‡ï¸ Checkout repo
        uses: actions/checkout@v4

      - name: ğŸ Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: 3.11

      - name: ğŸ“¦ Install dependencies
        run: pip install PyGithub pytz pyyaml

      - name: ğŸ“ Generate contribution report
        env:
          GITHUB_TOKEN: ${{ secrets.WEEKLY_TOKEN }}
        run: |
          python <<EOF
          import os
          from datetime import datetime, timedelta
          from github import Github
          import pytz
          import yaml

          token = os.environ["GITHUB_TOKEN"]
          g = Github(token)

          # Load repo categories from YAML file
          with open("repo-categories.yaml", "r") as f:
              config = yaml.safe_load(f)

          # Build repo_map from YAML config
          repo_map = {}
          for category_key, category_data in config["categories"].items():
              product_name = category_data["name"]
              for repo_name in category_data["repos"]:
                  repo_map[repo_name] = product_name

          repos = list(repo_map.keys())

          user = "sarahsdao"
          utc = pytz.UTC
          since = datetime.utcnow().replace(tzinfo=utc) - timedelta(days=7)
          until = datetime.utcnow().replace(tzinfo=utc)
          timestamp = datetime.utcnow().strftime('%Y-%m-%d')
          output_path = f"reports/report-{timestamp}.md"

          summary = []  # List of dicts for the summary table
          sections_content = []  # Store all section content

          os.makedirs("reports", exist_ok=True)

          for repo_name in repos:
              repo = g.get_repo(repo_name)
              product_name = repo_map[repo_name]
              print(f"ğŸ” Checking {product_name}...")

              pr_count = 0
              issue_count = 0
              closed_issue_count = 0
              review_count = 0

              # Collect PRs
              pr_list = []
              for pr in repo.get_pulls(state="all", sort="created", direction="desc"):
                  if pr.created_at < since:
                      break
                  if pr.user.login == user:
                      pr_list.append((pr.number, pr.title))
                      pr_count += 1

              # Collect Issues
              issue_list = []
              for issue in repo.get_issues(state="all", since=since):
                  if issue.pull_request is None and issue.user.login == user:
                      issue_list.append((issue.number, issue.title))
                      issue_count += 1

              # Collect Closed Issues
              closed_issue_list = []
              for issue in repo.get_issues(state="closed", since=since):
                  if issue.pull_request is None and issue.user.login == user:
                      closed_issue_list.append((issue.number, issue.title))
                      closed_issue_count += 1

              # Collect Reviews
              review_list = []
              for pr in repo.get_pulls(state="all", sort="created", direction="desc"):
                  if pr.created_at < since:
                      break
                  try:
                      for review in pr.get_reviews():
                          if review.user.login == user and since <= review.submitted_at.replace(tzinfo=utc) <= until:
                              review_list.append((pr.number, pr.title))
                              review_count += 1
                              break  # One review per PR
                  except Exception as e:
                      print(f"âš ï¸ Failed to fetch reviews for PR #{pr.number} in {product_name}: {e}")

              # Only create section if there's any activity
              has_activity = pr_count > 0 or issue_count > 0 or closed_issue_count > 0 or review_count > 0
              if has_activity:
                  section = f"## ğŸ“˜ {product_name}\\n\\n"

                  # Pull Requests - only show if there are any
                  if pr_list:
                      section += "### ğŸ”§ Pull Requests\\n"
                      for pr_num, pr_title in pr_list:
                          section += f"- [#{pr_num}] {pr_title}\\n"
                      section += "\\n"

                  # Issues - only show if there are any
                  if issue_list:
                      section += "### ğŸ› Issues\\n"
                      for issue_num, issue_title in issue_list:
                          section += f"- [#{issue_num}] {issue_title}\\n"
                      section += "\\n"

                  # Closed Issues - only show if there are any
                  if closed_issue_list:
                      section += "### âœ… Closed Issues\\n"
                      for issue_num, issue_title in closed_issue_list:
                          section += f"- [#{issue_num}] {issue_title} (closed)\\n"
                      section += "\\n"

                  # Reviews - only show if there are any
                  if review_list:
                      section += "### ğŸ‘€ PR Reviews\\n"
                      for pr_num, pr_title in review_list:
                          section += f"- [#{pr_num}] {pr_title} (reviewed)\\n"
                      section += "\\n"

                  section += "---\\n\\n"
                  sections_content.append(section)

                  summary.append({
                      "repo": product_name,
                      "prs": pr_count,
                      "issues": issue_count,
                      "closed_issues": closed_issue_count,
                      "reviews": review_count,
                  })

          # Now write everything in order
          with open(output_path, "w", encoding="utf-8") as f:
              # Write header
              f.write(f"# ğŸ“Š GitHub Contribution Report ({timestamp})\\n\\n")

              # Write summary table
              f.write("| Repository | PRs | Issues | Closed Issues | Reviews |\\n")
              f.write("|------------|-----|--------|---------------|---------|\\n")
              for entry in summary:
                  f.write(f"| {entry['repo']} | {entry['prs']} | {entry['issues']} | {entry['closed_issues']} | {entry['reviews']} |\\n")

              # Add totals row
              total_prs = sum(entry['prs'] for entry in summary)
              total_issues = sum(entry['issues'] for entry in summary)
              total_closed_issues = sum(entry['closed_issues'] for entry in summary)
              total_reviews = sum(entry['reviews'] for entry in summary)
              f.write(f"| **Total** | **{total_prs}** | **{total_issues}** | **{total_closed_issues}** | **{total_reviews}** |\\n\\n")

              # Write all sections
              for section in sections_content:
                  f.write(section)
          EOF

      - name: ğŸ“¤ Commit and push report
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git add reports/
          git commit -m "ğŸ—“ï¸ Weekly contribution report"
          git push
